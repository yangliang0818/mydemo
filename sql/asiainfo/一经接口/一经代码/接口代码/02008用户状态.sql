--创建本地侧全量用户
CREATE TABLE SHBASS.BASS1_02008_USER_STATUS_LOCAL_20150322
(
USER_ID VARCHAR(21),
USER_STATUS VARCHAR(4)
);
--插入本地侧全量用户状态
INSERT INTO SHBASS.BASS1_02008_USER_STATUS_LOCAL_20150322
SELECT A.SUB_ID,C.BASS1_VALUE AS SUB_STATUS  FROM SHBASS.BASS1_USER_SRVC_20150322 A JOIN
SHDW.DWD_SVC_USR_ALL_INFO_20150322 B ON A.SUB_ID=B.USER_ID
LEFT JOIN SHBASS.BASS1_MAP C ON B.BASS_USER_STATE_ID=C.BOSS_VALUE AND C.MAP_ID='BASS_STD1_0052';
CREATE TABLE SHBASS.BASS1_CUSTSTATUS_DAY_20150322
(
SUB_ID VARCHAR(21),
SUB_STATUS VARCHAR(4)
);
--1、用本地侧全量用户和前一天集团侧用户状态进行比较
INSERT INTO SHBASS.BASS1_CUSTSTATUS_DAY_20150322
SELECT USER_ID,USER_STATUS FROM BASS1_02008_USER_STATUS_LOCAL_20150322
EXCEPT
SELECT SUB_ID,SUB_STATUS FROM SHBASS.BASS1_USER_STATUS_20150321;
--2、更新状态数据
RUNSTATS ON TABLE SHBASS.BASS1_CUSTSTATUS_DAY_20150322;
--3、生成集团侧全量用户状态
CREATE TABLE SHBASS.BASS1_USER_STATUS_20150322
(
SUB_ID VARCHAR(21),
SUB_STATUS VARCHAR(4)
);
--4、用今天变化的数据和前一天去没有变化的数据合并生成集团侧全量用户数据
INSERT INTO SHBASS.BASS1_USER_STATUS_20150322
SELECT VALUE(B.SUB_ID,A.SUB_ID),VALUE(B.SUB_STATUS,A.SUB_STATUS) FROM SHBASS.BASS1_USER_STATUS_20150321 A
FULL JOIN SHBASS.BASS1_CUSTSTATUS_DAY_20150322 B
ON A.SUB_ID=B.SUB_ID;
--5、更新全量用户状态数据
RUNSTATS ON TABLE SHBASS.BASS1_USER_STATUS_20150322;
--6、将慢速变化的情况记录进入月表BASS1_CUSTSTATUS_DAY_201503 ，每月一号创建，后面只是做插入操作
CREATE TABLE SHBASS.BASS1_CUSTSTATUS_DAY_201502
(
SUB_ID VARCHAR(21),
SUB_STATUS VARCHAR(4),
OP_TIME VARCHAR(10)
);
INSERT INTO SHBASS.BASS1_CUSTSTATUS_DAY_201503
SELECT SUB_ID,SUB_STATUS,'程序运行日期' FROM SHBASS.BASS1_CUSTSTATUS_DAY_20150321
--7、更新表SHBASS.BASS1_CUSTSTATUS_DAY_201502
RUNSTATS ON TABLE SHBASS.BASS1_CUSTSTATUS_DAY_201503;
